language: bash
sudo: false

matrix:
  allow_failures:
  include:

    - os: linux
      dist: bionic
      env: PATH=/usr/bin:/bin:./:/usr/local/bin
      script:
        - openssl version
        - shellcheck --version
        - bash -c 'export SHELLCHECK_OPTS="-S warning -e SC2006"; shopt -s globstar; shellcheck **/*.sh easyrsa3/easyrsa'
        - sh op_test.sh -vv
    - os: linux
      dist: bionic
      env:
        - PATH=/usr/bin:/bin:./:/usr/local/bin
        - PKCS11_ENGINE=/usr/lib/x86_64-linux-gnu/engines-1.1/libpkcs11.so
        - PKCS11_MODULE_PATH=/usr/lib/softhsm/libsofthsm2.so
        - PKCS11_SLOT=01
        - PKCS11_PIN=1234
        - PKCS11_LABEL=test-CA-key
        - TEST_PKCS11=1       # Triggers op_test.sh to pass the pkcs11 parameter to build-ca
      before_install:
        # opensc to get pkcs11-tool
        - sudo apt-get install -y opensc softhsm2 libengine-pkcs11-openssl1.1 gnutls-bin
        - sudo mkdir -p /var/lib/softhsm/tokens
        - sudo softhsm2-util --init-token --free --label my-test-token --so-pin 123456 --pin 1234
      script:
        - export PKCS11_TOKEN_URI=$(sudo p11tool --list-tokens|grep -e 'URL.*SoftHSM.*'|awk  '{print $2 ";"}')
        - openssl version
        - shellcheck --version
        - bash -c 'export SHELLCHECK_OPTS="-S warning -e SC2006"; shopt -s globstar; shellcheck **/*.sh easyrsa3/easyrsa'
        - sudo sh op_test.orig -vv

    - os: osx
      osx_image: xcode10.1
      script:
        - openssl version
        - sh op_test.sh -vv
